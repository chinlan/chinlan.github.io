---
layout: post
title: "Rails: CSV Library"
description: ""
categories: [rails]
tags: []
redirect_from:
  - /2018/03/31/
---

情境：從[政府資料開放平臺](https://data.gov.tw/dataset/11339)上下載的

每日外幣參考匯率的資料檔案處理

### 處理CSV檔案
~~~ ruby
rows = CSV.read('path/to/file.csv')  #array of file row contents
~~~
rows output:
~~~
[["月別", "新台幣", "人民幣", "日圓", "韓元", "新加坡元", "歐元", "英鎊", "澳幣"], ["2017-01", "31.360", "6.8780", "113.77", "1159.2", "1.4181", "1.0731", "1.2628", "0.7557"], ["2017-02", "30.650", "6.8718", "112.73", "1131.5", "1.4050", "1.0595", "1.2547", "0.7715"], ["2017-03", "30.336", "6.8915", "111.79", "1118.4", "1.3969", "1.0691", "1.2464", "0.7657"], ["2017-04", "30.218", "6.8973", "111.28", "1137.9", "1.3959", "1.0886", "1.2937", "0.7473"], ["2017-05", "30.102", "6.8210", "110.95", "1119.5", "1.3840", "1.1185", "1.2811", "0.7451"], ["2017-06", "30.436", "6.7796", "112.06", "1144.1", "1.3770", "1.1412", "1.3009", "0.7675"], ["2017-07", "30.227", "6.7290", "110.62", "1119.0", "1.3569", "1.1725", "1.3118", "0.7976"], ["2017-08", "30.203", "6.5969", "110.49", "1127.8", "1.3590", "1.1892", "1.2903", "0.7898"], ["2017-09", "30.305", "6.6470", "112.44", "1145.4", "1.3578", "1.1794", "1.3405", "0.7846"], ["2017-10", "30.170", "6.6272", "113.08", "1120.4", "1.3606", "1.1645", "1.3216", "0.7682"], ["2017-11", "30.010", "6.6107", "112.29", "1088.2", "1.3481", "1.1865", "1.3456", "0.7579"], ["2017-12", "29.848", "6.5120", "112.66", "1070.5", "1.3371", "1.1952", "1.3470", "0.7794"], ["2018-01", "29.150", "6.2920", "108.69", "1067.9", "1.3091", "1.2446", "1.4187", "0.8090"]]
~~~

### 加上headers，更一目瞭然：
~~~ ruby
rows = CSV.read('path/to/file', headers: true)
~~~

rows[0] output:
~~~
#<CSV::Row "月別":"2017-01" "新台幣":"31.360" "人民幣":"6.8780" "日圓":"113.77" "韓元":"1159.2" "新加坡元":"1.4181" "歐元":"1.0731" "英鎊":"1.2628" "澳幣":"0.7557">
~~~

### 編碼問題
提供的檔案編碼格式是big5，要把它轉成utf-8。

~~~ ruby
raw_str = File.read('path/to/file.csv')
modified_str = raw_string.force_encoding('big5').encode('utf-8')
rows = CSV.parse(modified_str)
~~~
or
~~~ ruby
rows = CSV.parse(modified_str, headers: true)
~~~

沒有帶block的parse用起來和read一樣。


另一種更簡便的寫法，直接使用CSV library提供的option：
~~~ ruby
rows = CSV.read('path/to/file.csv', headers: true, encoding: 'big5:utf-8')
~~~

### 數字處理：
注意parse之後的結果都是string，要做數字處理可以設定converter:
~~~ ruby
rows = CSV.read('path/to/file.csv', headers: true, encoding: 'big5:utf-8', converters: :numeric)
~~~

[ref: ruby csv library](https://www.sitepoint.com/guide-ruby-csv-library-part/)

[ref: how to convert a string to utf-8 in ruby](https://stackoverflow.com/questions/17022394/how-to-convert-a-string-to-utf8-in-ruby)
